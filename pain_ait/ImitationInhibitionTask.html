<!DOCTYPE html>
<html>
	<head>
		<title>My experiment</title>
		<script src = "jspsych/jspsych-6.1.0/jspsych.js"></script>
		
		<!-- Regular plugins -->
		
		<script src = "jspsych/jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
		<script src = "jspsych/jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
		<script src = "jspsych/jspsych-6.1.0/plugins/jspsych-call-function.js"></script>
		<script src = "jspsych/jspsych-6.1.0/plugins/jspsych-video-keyboard-response.js"></script>
		<script src = "jspsych/jspsych-6.1.0/plugins/jspsych-survey-html-form.js"></script>
		<!-- My plugins -->
		
		<script src = "jspsych/jspsych-6.1.0/plugins/my_plugins/jspsych-fixation-image-keyboard-release.js"></script>
		<script src = "jspsych/jspsych-6.1.0/plugins/my_plugins/jspsych-check-response.js"></script>
		
		<!-- CSS -->
		
		<link href = "jspsych/jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
			
		<style>
			.my_window { width: 80vw; height: auto; max-width: 100%; position: relative;}
			.my_window p { font-family: Arial; font-size: 14pt; line-height: 1.25; }
		</style>
	</head>	
	<body style="background-color:black;color:white;"></body>
	<script>

	/////////////////
	///  GLOBALS  ///
	/////////////////
	
	/* TIMELINE */

	var timeline = [];
	
	/* SUBJECT ID */
	
	var subject_id = jsPsych.randomization.randomID(15);
	
	/* EVENT FUNCTIONS */
	
	var keys_down = [];
	
	function my_keydown(e){
		my_key = jsPsych.pluginAPI.convertKeyCharacterToKeyCode(e.key) || e.keyCode;
		if(keys_down[my_key] != true){ // prevents constant updating (not sure if necessary)
			keys_down[my_key] = true;
		}
	};
	
	function my_keyup(e){
		my_key = jsPsych.pluginAPI.convertKeyCharacterToKeyCode(e.key) || e.keyCode;
		keys_down[my_key] = false;
	};
	
	/* TASK SETTINGS */
	
	var left_key = jsPsych.pluginAPI.convertKeyCharacterToKeyCode('g');
	var right_key = jsPsych.pluginAPI.convertKeyCharacterToKeyCode('h');
		
	/////////////////////
	///  FULL SCREEN  ///
	/////////////////////
		
	var fullscreen_on = {
		type: 'fullscreen',
		fullscreen_mode: true
	};
	
	timeline.push(fullscreen_on);
	
	////////////////////
	///  HIDE MOUSE  ///
	////////////////////
	
	var no_mouse = {
		type: 'call-function',
		func: function(){ 
			document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>'); 
		}
	};
	
	timeline.push(no_mouse);
	
	/////////////////////////////
	///  ADD EVENT LISTENERS  ///
	/////////////////////////////
	
	var add_listeners = {
		type: 'call-function',
		func: function(){ 
			document.addEventListener("keydown", my_keydown, false);
			document.addEventListener("keyup", my_keyup, false);
		}
	};
	
	timeline.push(add_listeners);
		
	//////////////////////
	///  INSTRUCTIONS  ///
	//////////////////////
	
	var Consent = {
		type: 'html-keyboard-response',
		choices: ['enter'],
		stimulus: "<div class = 'my_window'>"+
				  "<p><h1>Welcome!</h1><br><p>"+
				  "<p>This experiment is adminterested by Carl Michael Galang (McMaster University) & Dr. Sukhvinder Obhi (McMaster University).</p><br>"+
				  "<p>This experiment investigates how quickly and accurately people are able to respond to visual cues, and how these responses are affected by seeing movements.Some of the videos you will be watching contain content that portrays another person in pain (e.g. needle stabbing someoneâ€™s hand).</p><br>"+
				  "<p>Information gathered during this study will be written up for publication in an academic journal. While there are no direct benefits to you taking part in this study (other than learning more about the research topic and receiving 1 credit on SONA), the results of this study will provide a better understand of neuropsychological processes. To learn about this study, particularly in terms of any associated risks or harms, how confidentiality and anonymity will be handled, withdrawal procedures, incentives that are promised, how to obtain information about the results, etc., please read the accompanying letter of information - <a href='LOI.pdf' target='_blank'>Click Here</a> (this will open a new window).</p<br>"+
				  "<p>This study should take around 30-40min to complete. Please finish this study within an hour of starting it (there are built-in breaks embedded in the experiment).</p><br>"+
				  "<p>Please note that you will be given a unique compleition code at the end of this study to input into a Google Forms (link at the end) to get your SONA credit.</p>"+
				  "<p>If you have questions or need more information about the study itself, please contact me at: galangc@mcmaster.ca. This study has been reviewed by the McMaster University Research Ethics Board and received ethics clearance. If you have concerns or questions about your rights as a participant or about the way the study is conducted, please contact the McMaster Research Ethics Secretariat at ethicsoffice@mcmaster.ca.</p><br>"+
				  "<p><h1>CONSENT</h1></p>"+
				  "<p>I have read the information presented in the letter of information and I agree to participate in this study.</p><br>"+
				  "<p>By pressing Enter, I consent to the above.<p>",
		post_trial_gap: 0
	}

	var code = Math.floor((Math.random() * 10000000) + 10000);
	var goodbye = {
  		type: 'survey-html-form',
  		preamble: '<p><h1>This is the end of the experiment.</h1></p>',
  		html: "<div class = 'my_window'>"+
				  "<p>Here is your unique completion code: "+ code +
				  "<p>Please <a href='https://docs.google.com/forms/d/e/1FAIpQLSeHeB9DA-80wKlXABd4zxpgdhNSBb6sb_g7MgwBPs_evHZnVw/viewform?usp=sf_link' target='_blank'>Click Here</a> (this will open a new window) to enter your MacID and code to get your SONA credit. All SONA credits will be awarded within 2 weeks. Please email galangc@mcmaster.ca if there are any issues.</p>"+
				  "<p>If you would like to find out more about the study, <a href='Debrief.pdf' target='_blank'>Click Here</a> (this will open a new window) to read the debrief form.</p><br>",
		button_label: "Submit",
		on_finish: function(data) {
			data.code = code
		}
	};

	timeline.push(goodbye)
	var after_practice = {
		type: 'html-keyboard-response',
		choices: ['enter'],
		stimulus: "<div class = 'my_window'>"+
				  "<p>Great Job! In the main part of the experiment, you will NOT be given any feedback (correct vs. incorrect). "+
				  "In addition, between each number trial, you will be shown videos of a hand getting stabbed by a needle or touched by a Q-tip. "+
				  "Try to imagine what the person is experiencing while watching these videos.</p><br>" +

				  "<p>As before, hold down the G and H keys with your RIGHT HAND. If you see the number 1, release the G key by lifting your index finger. "+
				  "If you see the number 2, release the H key by lifting your middle finger. Then hold down both keys again. "+
				  "Ignore the hand in the background. You will complete 5 blocks with 48 trials each. There will be self-paced breaks in between each block. Press Enter to begin.</p></div>",
		post_trial_gap: 0
	};

	var brk = {
		type: 'html-keyboard-response',
		choices: ['enter'],
		stimulus: "<div class = 'my_window'>"+
				  "<p>BREAK. Press Enter whenever you're ready to begin the next block.</p></div>",
		post_trial_gap: 0
	};
	
	timeline.push(Consent);
	
	///////////////////////
	///  RANDOMIZATION  ///
	///////////////////////
	
	var design = [

		// Index Congruent //
		{img1: "Stim/fix.bmp", img2: "Stim/movI_cueI.bmp", video: "video stimuli/N1.mp4", data: {test: 'exp', finger: 1, cue: 0, con: "C", correct_response: "g", vid: "N1"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movI_cueI.bmp", video: "video stimuli/N2.mp4", data: {test: 'exp', finger: 1, cue: 0, con: "C", correct_response: "g", vid: "N2"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movI_cueI.bmp", video: "video stimuli/N3.mp4", data: {test: 'exp', finger: 1, cue: 0, con: "C", correct_response: "g", vid: "N3"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movI_cueI.bmp", video: "video stimuli/Q1.mp4", data: {test: 'exp', finger: 1, cue: 0, con: "C", correct_response: "g", vid: "Q1"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movI_cueI.bmp", video: "video stimuli/Q2.mp4", data: {test: 'exp', finger: 1, cue: 0, con: "C", correct_response: "g", vid: "Q2"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movI_cueI.bmp", video: "video stimuli/Q3.mp4", data: {test: 'exp', finger: 1, cue: 0, con: "C", correct_response: "g", vid: "Q3"}},

		// Index Incongruent //
		{img1: "Stim/fix.bmp", img2: "Stim/movI_cueM.bmp", video: "video stimuli/N1.mp4", data: {test: 'exp', finger: 1, cue: 1, con: "IC", correct_response: "h", vid: "N1"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movI_cueM.bmp", video: "video stimuli/N2.mp4", data: {test: 'exp', finger: 1, cue: 1, con: "IC", correct_response: "h", vid: "N2"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movI_cueM.bmp", video: "video stimuli/N3.mp4", data: {test: 'exp', finger: 1, cue: 1, con: "IC", correct_response: "h", vid: "N3"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movI_cueM.bmp", video: "video stimuli/Q1.mp4", data: {test: 'exp', finger: 1, cue: 1, con: "IC", correct_response: "h", vid: "Q1"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movI_cueM.bmp", video: "video stimuli/Q2.mp4", data: {test: 'exp', finger: 1, cue: 1, con: "IC", correct_response: "h", vid: "Q2"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movI_cueM.bmp", video: "video stimuli/Q3.mp4", data: {test: 'exp', finger: 1, cue: 1, con: "IC", correct_response: "h", vid: "Q3"}},

		// Middle Incongruent //
		{img1: "Stim/fix.bmp", img2: "Stim/movM_cueI.bmp", video: "video stimuli/N1.mp4", data: {test: 'exp', finger: 2, cue: 0, con: "IC", correct_response: "g", vid: "N1"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movM_cueI.bmp", video: "video stimuli/N2.mp4", data: {test: 'exp', finger: 2, cue: 0, con: "IC", correct_response: "g", vid: "N2"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movM_cueI.bmp", video: "video stimuli/N3.mp4", data: {test: 'exp', finger: 2, cue: 0, con: "IC", correct_response: "g", vid: "N3"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movM_cueI.bmp", video: "video stimuli/Q1.mp4", data: {test: 'exp', finger: 2, cue: 0, con: "IC", correct_response: "g", vid: "Q1"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movM_cueI.bmp", video: "video stimuli/Q2.mp4", data: {test: 'exp', finger: 2, cue: 0, con: "IC", correct_response: "g", vid: "Q2"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movM_cueI.bmp", video: "video stimuli/Q3.mp4", data: {test: 'exp', finger: 2, cue: 0, con: "IC", correct_response: "g", vid: "Q3"}},

		// Middle Congruent //
		{img1: "Stim/fix.bmp", img2: "Stim/movM_cueM.bmp", video: "video stimuli/N1.mp4", data: {test: 'exp', finger: 2, cue: 1, con: "C", correct_response: "h", vid: "N1"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movM_cueM.bmp", video: "video stimuli/N2.mp4", data: {test: 'exp', finger: 2, cue: 1, con: "C", correct_response: "h", vid: "N2"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movM_cueM.bmp", video: "video stimuli/N3.mp4", data: {test: 'exp', finger: 2, cue: 1, con: "C", correct_response: "h", vid: "N3"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movM_cueM.bmp", video: "video stimuli/Q1.mp4", data: {test: 'exp', finger: 2, cue: 1, con: "C", correct_response: "h", vid: "Q1"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movM_cueM.bmp", video: "video stimuli/Q2.mp4", data: {test: 'exp', finger: 2, cue: 1, con: "C", correct_response: "h", vid: "Q2"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movM_cueM.bmp", video: "video stimuli/Q3.mp4", data: {test: 'exp', finger: 2, cue: 1, con: "C", correct_response: "h", vid: "Q3"}}
	];

	var practiceBlock = [
		{img1: "Stim/fix.bmp", img2: "Stim/movI_cueI.bmp", data: {test: 'practice', finger: 1, cue: 0, con: "C", correct_response: "g"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movI_cueM.bmp", data: {test: 'practice', finger: 1, cue: 1, con: "IC", correct_response: "h"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movM_cueI.bmp", data: {test: 'practice', finger: 2, cue: 0, con: "IC", correct_response: "g"}},
		{img1: "Stim/fix.bmp", img2: "Stim/movM_cueM.bmp", data: {test: 'practice', finger: 2, cue: 1, con: "C", correct_response: "h"}}
	];
			
	///////////////////////////////////
	///  IMITATION-INHIBITION TASK  ///
	///////////////////////////////////
	
	/* KEYS HELD DOWN? */
	
	var no_response = {
		type: "check-response",
		stimulus: '<div style="font-size:30px;">HOLD DOWN THE G AND H KEYS</div>',
		trial_duration: 1
	};	

	var loop_no_response = {
		timeline: [no_response],
		loop_function: function(){	
			if(keys_down[left_key] == true && keys_down[right_key] == true){
				return false;
			} else {				
				return true;				
			}
		}
	};
		
	var if_no_response = {
		timeline: [loop_no_response],
		conditional_function: function(){
			if(keys_down[left_key] == true && keys_down[right_key] == true){
				return false;
			} else {
				return true;
			}
		}
	};
	
	/* IMITATION-INHIBITION TRIAL */
	
	var imi_inh = {
		type: "fixation-image-keyboard-release",		
		fixation: jsPsych.timelineVariable("img1"),		
		stimulus: jsPsych.timelineVariable("img2"),	
		choices: [left_key, right_key],
		fixation_duration: 500,
		trial_duration: 2000,		
		post_trial_gap: 1000,
		data: jsPsych.timelineVariable("data"),
		on_finish: function(data){
    		data.correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(data.correct_response);
    	}
	};

	/* Video Stimuli */
	var vidTrial = {
    	type: 'video-keyboard-response',
    	sources: [jsPsych.timelineVariable("video")],	
    	choices: jsPsych.NO_KEYS,
    	trial_ends_after_video: true
	}

	
	/* Practice trials */
	var feedback = {
      type: "html-keyboard-response",
      trial_duration: 1000,
   	  choices: jsPsych.NO_KEYS,
      stimulus: function() {
		var trials = jsPsych.data.get().select('correct');
		var value = trials.values.pop()
        if (value == true) {
        	return "<p> CORRECT </p>"
        } else {
        	return "<p> INCORRECT </p>"
        };
      }
    };

	var run_practice = {
		timeline: [if_no_response, imi_inh, feedback],
		timeline_variables: practiceBlock,
		loop_function: function(data){
			var trials = data.select('correct');
			var value = trials.values.pop()
			console.log(value)
			if (value == true) {
        		return false
       	 	} else {
        		return true
        	}
		},
		sample: {
			type: 'with-replacement',
			size: 1
		}
	};


	timeline.push(run_practice)
	timeline.push(run_practice)
	timeline.push(run_practice)
	timeline.push(run_practice)
	timeline.push(run_practice)
	timeline.push(run_practice)
	timeline.push(run_practice)
	timeline.push(run_practice)
	timeline.push(run_practice)
	timeline.push(run_practice)

	timeline.push(after_practice)

	/* RUN EXPERIMENT */	
	
	var run_experiment = {
		timeline: [if_no_response, vidTrial, imi_inh],
		timeline_variables: design,
		sample: {
			type: 'without-replacement'
		}
	};
	
	timeline.push(run_experiment);
	timeline.push(run_experiment);
	timeline.push(brk);
	timeline.push(run_experiment);
	timeline.push(run_experiment);
	timeline.push(run_experiment);
	timeline.push(brk);
	timeline.push(run_experiment);
	timeline.push(run_experiment);
	timeline.push(brk);
	timeline.push(run_experiment);
	timeline.push(run_experiment);
	timeline.push(brk);
	timeline.push(run_experiment);
	timeline.push(run_experiment);
	
	////////////////////////////////
	///  REMOVE EVENT LISTENERS  ///
	////////////////////////////////
	
	var remove_listeners = {
		type: 'call-function',
		func: function(){ 
			document.removeEventListener("keydown", my_keydown, false);
			document.removeEventListener("keyup", my_keyup, false);
		}
	};
	
	timeline.push(remove_listeners);

	/////////////////
	///  GOODBYE  ///
	/////////////////
		
	var goodbye = {
		type: 'html-keyboard-response',
		choices: ['enter'],
		stimulus: "<div class = 'my_window'>"+
				  "<p>This is the end of the experiment</p><br>"+
				  "<p>Press ENTER to leave fullscreen.</p></div>",
		post_trial_gap: 0
	};
		
	timeline.push(goodbye);
	
	////////////////////
	///  SHOW MOUSE  ///
	////////////////////
	
	var mouse = {
		type: 'call-function',
		func: function(){ 
			document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: default; } </style>');
		}
	};
	
	timeline.push(mouse);

	//////////////////////////
	///  CLOSE FULLSCREEN  ///
	//////////////////////////
	
	var fullscreen_off = {
		type: 'fullscreen',
		fullscreen_mode: false
	};
	
	timeline.push(fullscreen_off);

	////////////////////////
	///  RUN EXPERIMENT  ///
	////////////////////////

	jsPsych.init({
		timeline: timeline,
		exclusions: {min_width: 1280, min_height: 700},
		preload_images: ["Stim/fix.bmp","Stim/movI_cueI.bmp","Stim/movI_cueM.bmp","Stim/movM_cueI.bmp","Stim/movM_cueM.bmp"],
		show_preload_progress_bar: true,
		on_finish: function() {
			jsPsych.data.displayData();
			jsPsych.data.get().filter({test: 'exp'}).localSave('csv',subject_id+'.csv');
		}		
	});

	</script>
</html>